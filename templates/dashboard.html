<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>çµŒå–¶æˆ¦ç•¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='humbergur.css') }}">
  <!-- ã‚°ãƒ©ãƒ•ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <div id="menu-icon" class="menu-icon">
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
    </div>
    <h1 style="margin: 0; font-size: 1.5em;">çµŒå–¶æˆ¦ç•¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
  </header>

  <nav id="sidebar" class="sidebar">
    <ul>
      <li><a href="/">ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸</a></li>
      <li><a href="/dashboard">çµŒå–¶æˆ¦ç•¥</a></li>
      <li><a href="search.html">é¡§å®¢IDæ¤œç´¢</a></li>
      <li><a href="stock.html">åœ¨åº«ãƒªã‚¹ãƒˆ</a></li>
    </ul>
  </nav>


  <!-- ===============================
       ğŸ” é¡§å®¢å±æ€§ãƒ•ã‚£ãƒ«ã‚¿
  ================================ -->
  <h2>ğŸ” é¡§å®¢å±æ€§ãƒ•ã‚£ãƒ«ã‚¿</h2>
  <div class="filter-form">
    <form method="GET" action="">
      <label for="gender">æ€§åˆ¥:</label>
      <select name="gender" id="gender" style="padding: 5px;">
        <option value="">å…¨ã¦</option>
        <option value="1" {% if gender_filter == '1' %}selected{% endif %}>ç”·æ€§</option>
        <option value="2" {% if gender_filter == '2' %}selected{% endif %}>å¥³æ€§</option>
      </select>

      <label for="min_age">å¹´é½¢ (æœ€å°):</label>
      <input type="number" name="min_age" id="min_age"
             value="{{ min_age_filter if min_age_filter is not none else '' }}"
             min="0" style="width: 80px; padding: 5px;">

      <label for="max_age">å¹´é½¢ (æœ€å¤§):</label>
      <input type="number" name="max_age" id="max_age"
             value="{{ max_age_filter if max_age_filter is not none else '' }}"
             min="0" style="width: 80px; padding: 5px;">

      <label for="area">åœ°åŸŸ:</label>
      <select name="area" id="area" style="padding: 5px;">
        <option value="">å…¨ã¦</option>
        {% for a in area_list %}
        <option value="{{ a }}" {% if area_filter == a %}selected{% endif %}>{{ a }}</option>
        {% endfor %}
      </select>

      <button type="submit"
              style="padding: 6px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
        ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨ / æ¤œç´¢
      </button>
      <button type="button"
              onclick="window.location.href='/dashboard'"
              style="padding: 6px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
        ãƒªã‚»ãƒƒãƒˆ
      </button>
    </form>

    <div class="filter-status">
      é©ç”¨ä¸­ã®æ¡ä»¶:
      {% set has_condition = false %}
      {% if gender_filter %}
        {% set has_condition = true %}
        <strong>æ€§åˆ¥</strong>:
        {% if gender_filter == '1' %}ç”·æ€§{% elif gender_filter == '2' %}å¥³æ€§{% else %}ãã®ä»–{% endif %}
      {% endif %}
      {% if min_age_filter is not none %}
        {% set has_condition = true %}
        &nbsp;/ <strong>æœ€å°å¹´é½¢</strong>: {{ min_age_filter }}æ­³
      {% endif %}
      {% if max_age_filter is not none %}
        {% set has_condition = true %}
        &nbsp;/ <strong>æœ€å¤§å¹´é½¢</strong>: {{ max_age_filter }}æ­³
      {% endif %}
      {% if area_filter %}
        {% set has_condition = true %}
        &nbsp;/ <strong>åœ°åŸŸ</strong>: {{ area_filter }}
      {% endif %}
      {% if not has_condition %}
        ãªã— (å…¨ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º)
      {% endif %}
    </div>
  </div>

  <!-- ===============================
       ğŸ“ˆ ç·åˆKPI
  ================================ -->
  <h2>ğŸ“ˆ ç·åˆKPI (æ¤œç´¢çµæœ)</h2>
  <div class="kpi-container">
    <div class="kpi-box">
      <h3>ç·é¡§å®¢æ•°</h3>
      <div class="kpi-value">{{ total_customers | format_currency }}äºº</div>
    </div>
    <div class="kpi-box">
      <h3>ç·å£²ä¸Šé‡‘é¡</h3>
      <div class="kpi-value">Â¥{{ total_sales | format_currency }}</div>
    </div>
    <div class="kpi-box">
      <h3>å¹³å‡é¡§å®¢å˜ä¾¡ (ARPU)</h3>
      <div class="kpi-value">Â¥{{ avg_sales | format_currency }}</div>
    </div>
  </div>

<!-- ===============================
    ğŸ—¾ åœ°åŸŸåˆ¥å£²ä¸Šã‚µãƒãƒª
================================ -->
<h2>ğŸ—¾ åœ°åŸŸåˆ¥å£²ä¸Šã‚µãƒãƒªï¼ˆåœ°å›³ / ã‚°ãƒ©ãƒ• / è¡¨ åˆ‡æ›¿ï¼‰</h2>

<div style="margin-bottom: 10px;">
  <button id="regionMapBtn"   class="toggle-btn active-btn">åœ°å›³</button>
  <button id="regionGraphBtn" class="toggle-btn">ã‚°ãƒ©ãƒ•</button>
  <button id="regionTableBtn" class="toggle-btn">è¡¨</button>
</div>


<!-- â–¼ ã‚«ãƒ©ãƒ¼ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ï¼ˆåœ°å›³è¡¨ç¤ºä¸­ã®ã¿è¡¨ç¤ºï¼‰ -->
<div id="colorLegend" style="
  display:none;
  margin: 10px 0 20px;
  padding: 10px;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 6px;
  width: 260px;
">
  <strong>å£²ä¸Šã‚«ãƒ©ãƒ¼å‡¡ä¾‹</strong>
  <div style="display:flex; align-items:center; margin-top:8px;">
    <div style="width:24px; height:24px; background:rgb(213,255,204); margin-right:8px;"></div>
    <span>æœ€ä½å£²ä¸Š</span>
  </div>
  <div style="display:flex; align-items:center; margin-top:8px;">
    <div style="width:24px; height:24px; background:rgb(73,175,50); margin-right:8px;"></div>
    <span>æœ€é«˜å£²ä¸Š</span>
  </div>
</div>

<!-- â–¼ åœ°å›³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<div id="regionMap" style="display:block; width:100%; padding:20px 0;">
  <div style="width:90%; max-width:900px; margin:auto;">
    {% include 'japan_map.svg' %}
  </div>
</div>

<!-- â–¼ ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<div id="regionGraph" style="display:none; width:100%; padding:20px 0;">
  <div style="width:90%; max-width:1200px; margin:auto;">
    <canvas id="regionBarChart"></canvas>
  </div>
</div>

<!-- â–¼ è¡¨è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<div id="regionTable" style="display:none;">
  <table>
    <thead>
      <tr>
        <th>åœ°åŸŸ</th>
        <th>é¡§å®¢æ•°</th>
        <th>ç·å£²ä¸Š</th>
        <th>é¡§å®¢ã‚ãŸã‚Šå¹³å‡å£²ä¸Š</th>
      </tr>
    </thead>
    <tbody>
      {% for r in area_summary %}
      <tr>
        <td>{{ r.area }}</td>
        <td>{{ r.customers }}</td>
        <td>Â¥{{ r.total_sales | format_currency }}</td>
        <td>Â¥{{ r.avg_sales_per_customer | format_currency }}</td>
      </tr>
      {% endfor %}
      {% if area_summary|length == 0 %}
      <tr><td colspan="4">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

  

  <!-- ===============================
       ğŸ‘¥ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†æï¼ˆå¹´ä»£ Ã— æ€§åˆ¥ï¼‰
  ================================ -->
  <h2>ğŸ‘¥ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†æï¼ˆå¹´ä»£ Ã— æ€§åˆ¥ï¼‰</h2>

  <div style="margin-bottom: 10px;">
    <button id="segGraphBtn" class="toggle-btn active-btn">ã‚°ãƒ©ãƒ•</button>
    <button id="segTableBtn" class="toggle-btn">è¡¨</button>
  </div>

  <!-- â–¼ ã‚°ãƒ©ãƒ•è¡¨ç¤º -->
  <div id="segGraph" style="display:block;">
    <canvas id="segStackBar" height="120"></canvas>
  </div>

  <!-- â–¼ è¡¨è¡¨ç¤º -->
  <div id="segTable" style="display:none;">
    <table>
      <thead>
        <tr>
          <th>å¹´ä»£</th>
          <th>æ€§åˆ¥</th>
          <th>é¡§å®¢æ•°</th>
          <th>ç·å£²ä¸Š</th>
        </tr>
      </thead>
      <tbody>
        {% for s in age_gender %}
        <tr>
          <td>{{ s.age_group }}ä»£</td>
          <td>
            {% if s.sex == 1 %}ç”·æ€§
            {% elif s.sex == 2 %}å¥³æ€§
            {% else %}ãã®ä»–{% endif %}
          </td>
          <td>{{ s.customer_count }}</td>
          <td>Â¥{{ s.total_sales | format_currency }}</td>
        </tr>
        {% endfor %}
        {% if age_gender|length == 0 %}
        <tr><td colspan="4">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- ===============================
       ğŸ… é¡§å®¢ãƒ©ãƒ³ã‚­ãƒ³ã‚°
  ================================ -->
  <h2>ğŸ… é¡§å®¢ãƒ©ãƒ³ã‚­ãƒ³ã‚° (æ¤œç´¢çµæœã«åŸºã¥ã)</h2>
  <div class="ranking-section">
    <div class="ranking-box">
      <h3>è³¼å…¥å›æ•°</h3>
      <table>
        <thead>
          <tr><th>é †ä½</th><th>é¡§å®¢ID</th><th>æ°å</th><th>å›æ•°</th></tr>
        </thead>
        <tbody>
          {% for cust in top_freq %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ cust.customerid }}</td>
            <td>{{ cust.lastname }} {{ cust.firstname }}</td>
            <td>{{ cust.purchase_count | int }}å›</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="ranking-box">
      <h3>åˆè¨ˆè³¼å…¥é‡‘é¡</h3>
      <table>
        <thead>
          <tr><th>é †ä½</th><th>é¡§å®¢ID</th><th>æ°å</th><th>é‡‘é¡</th></tr>
        </thead>
        <tbody>
          {% for cust in top_spend %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ cust.customerid }}</td>
            <td>{{ cust.lastname }} {{ cust.firstname }}</td>
            <td>Â¥{{ cust.total_spent | format_currency }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ===============================
       JS èª­ã¿è¾¼ã¿
  ================================ -->
  <script src="{{ url_for('static', filename='humbergur.js') }}"></script>

  <!-- Flask ã‹ã‚‰ JS ã¸ãƒ‡ãƒ¼ã‚¿å—ã‘æ¸¡ã— -->
  <script>
    window.regionDataFromFlask = {{ area_summary | tojson }};
    window.segDataFromFlask = {{ age_gender | tojson }};
  </script>

  <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ã®æç”»ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ -->
  <script src="{{ url_for('static', filename='dashboard.js') }}"></script>
</body>
</html>
